generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("ENTITLEMENT_DATABASE_URL")
}

enum Tier {
  community
  pro
  enterprise
}

enum SubscriptionStatus {
  active
  canceled
  past_due
  trialing
  incomplete
  incomplete_expired
  unpaid
  paused
}

model Customer {
  id             String   @id @default(cuid())
  email          String   @unique
  name           String?
  stripeId       String?  @unique @map("stripe_id")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  licenses       License[]
  subscriptions  Subscription[]
  tenants        Tenant[]

  @@map("customers")
}

enum TenantStatus {
  pending
  provisioning
  ready
  error
  suspended
  deleting
}

model Tenant {
  id            String       @id @default(cuid())
  name          String
  subdomain     String       @unique
  email         String
  status        TenantStatus @default(pending)
  statusMessage String?      @map("status_message")
  customerId    String?      @map("customer_id")
  dbSchema      String       @map("db_schema")
  imageTag      String       @default("latest") @map("image_tag")
  domain        String?      @unique
  createdAt     DateTime     @default(now()) @map("created_at")
  updatedAt     DateTime     @updatedAt @map("updated_at")

  customer      Customer?    @relation(fields: [customerId], references: [id])
  users         User[]
  invitations   Invitation[]

  @@index([subdomain])
  @@index([status])
  @@index([customerId])
  @@map("tenants")
}

model License {
  id             String   @id @default(cuid())
  key            String   @unique
  customerId     String   @map("customer_id")
  tier           Tier
  instanceLimit  Int      @default(1) @map("instance_limit")
  expiresAt      DateTime? @map("expires_at")
  active         Boolean  @default(true)
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  customer       Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  validations    LicenseValidation[]

  @@index([customerId])
  @@index([key])
  @@index([active])
  @@map("licenses")
}

model Subscription {
  id                String   @id @default(cuid())
  customerId        String   @map("customer_id")
  stripeSubscriptionId String @unique @map("stripe_subscription_id")
  stripePriceId     String   @map("stripe_price_id")
  stripeEventId     String?  @unique @map("stripe_event_id")
  tier              Tier
  status            SubscriptionStatus
  currentPeriodStart DateTime @map("current_period_start")
  currentPeriodEnd   DateTime @map("current_period_end")
  cancelAtPeriodEnd  Boolean  @default(false) @map("cancel_at_period_end")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime @updatedAt @map("updated_at")

  customer          Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([stripeSubscriptionId])
  @@map("subscriptions")
}

model LicenseValidation {
  id          String   @id @default(cuid())
  licenseId   String   @map("license_id")
  instanceId  String   @map("instance_id")
  version     String?
  platform    String?
  nodeVersion String?  @map("node_version")
  validatedAt DateTime @default(now()) @map("validated_at")

  license     License  @relation(fields: [licenseId], references: [id], onDelete: Cascade)

  @@index([licenseId])
  @@index([instanceId])
  @@index([validatedAt])
  @@map("license_validations")
}

enum AuthProvider {
  google
  github
}

enum UserRole {
  admin
  member
}

model User {
  id          String       @id @default(cuid())
  email       String       @unique
  name        String?
  avatarUrl   String?      @map("avatar_url")
  provider    AuthProvider
  providerId  String       @map("provider_id")
  tenantId    String       @map("tenant_id")
  role        UserRole     @default(member)
  isOwner     Boolean      @default(false) @map("is_owner")
  createdAt   DateTime     @default(now()) @map("created_at")
  updatedAt   DateTime     @updatedAt @map("updated_at")

  tenant      Tenant       @relation(fields: [tenantId], references: [id])

  @@index([tenantId])
  @@index([email])
  @@map("users")
}

enum InvitationStatus {
  pending
  accepted
  revoked
}

model Invitation {
  id         String           @id @default(cuid())
  email      String
  tenantId   String           @map("tenant_id")
  invitedBy  String           @map("invited_by")
  role       UserRole         @default(member)
  status     InvitationStatus @default(pending)
  createdAt  DateTime         @default(now()) @map("created_at")
  expiresAt  DateTime         @map("expires_at")

  tenant     Tenant           @relation(fields: [tenantId], references: [id])

  @@unique([email, tenantId])
  @@index([tenantId])
  @@index([email])
  @@map("invitations")
}
